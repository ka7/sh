#!/usr/bin/env bash
# .sh/bin/setup-all 20170519 - 20210406
# Copyright (C) 1995-2021 Mark Constable <markc@renta.net> (AGPL-3.0)

export PATH=/bin:/usr/bin:/sbin:/usr/sbin:/root/.sh/bin

[[ $1 =~ '-h' ]] && echo "Usage: setup-all [vhost] [dtype]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

export MHOST=${1:-$(hostname -f|tr 'A-Z' 'a-z')}
export DTYPE=${2:-${DTYPE:-'mysql'}}

setup-host
setup-db $DTYPE
setup-etc
setup-fqdn $MHOST
setup-hcp

[[ -z $MAILTO ]] && MAILTO="admin@$VHOST"

echo "### Send message to: $MAILTO"
cat /root/.vhosts/$MHOST.conf /root/.vhosts/$VHOST.conf | \
 mail -s "Setup $VHOST - $IP4_0" -r admin@$VHOST $MAILTO
