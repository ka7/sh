#!/usr/bin/env bash
# .sh/bin/spamf 20180329 - 20180329
# Copyright (C) 2015-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 || $1 =~ '-h' ]] && echo "Usage: spamf user@domain [on|off|(show status)]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

source ~/.shrc || exit 3

SPAMF=$(echo "SELECT spamf FROM vmails WHERE user='$1'" | $SQCMD)

if [[ -z $SPAMF ]]; then
    echo "ERROR: no such user '$1'"
elif [[ $2 && $2 == on ]]; then
    if [[ $SPAMF -eq 1 ]]; then
        echo "Spam setting for $1 is already on"
    else
        echo "Spam setting for $1 is now on"
        echo "UPDATE vmails SET spamf=1 WHERE user='$1'" | $SQCMD
        cd $MPATH && ln -s sieve/spamprobe.sieve .dovecot.sieve
    fi
elif [[ $2 && $2 == off ]]; then
    if [[ $SPAMF -eq 1 ]]; then
        echo "Spam setting for $1 is already on"
    else
        echo "Spam setting for $1 is now off"
        echo "UPDATE vmails SET spamf=0 WHERE user='$1'" | $SQCMD
        cd $MPATH && rm .dovecot.sieve
    fi
else
    echo "Spam setting for $1 is $([[ $SPAMF -eq 1 ]] && echo on || echo off)"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
