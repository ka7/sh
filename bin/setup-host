#!/usr/bin/env bash
# .sh/bin/setup-host 20170524 - 20171029
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 == '-h' || $1 == '--help' ]] && echo "Usage: setup-host [-h|--help|mysql|sqlite(default)]" && exit 1
[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2
[[ ! -d ~/.sh ]] && echo "ERROR: missing ~/.sh, see https://github.com/netserva/sh" && exit 3

DTYPE=${1:-'sqlite'}

source ~/.sh/lib/functions

# Basic host dependency list, adjust accordingly
HLIST="
  bc
  bind9-host
  bsd-mailx
  ca-certificates
  curl
  git
  mutt
  nano
  openssh-server
  pwgen
  rsync
  ssmtp
"

if [[ ! -e /usr/bin/pwgen ]]; then
    echo "!!! Initial package update, patience please..."
    apt-get -yqq update > /dev/null
    DEBIAN_FRONTEND=noninteractive apt-get -yqq --no-install-recommends -u dist-upgrade > /dev/null
    echo "!!! Installing default package set, more patience..."
    DEBIAN_FRONTEND=noninteractive apt-get -yqq --no-install-recommends install $HLIST > /dev/null
fi

if [[ -f ~/.defaults ]]; then
    echo "!!! Source ~/.defaults"
    source ~/.defaults
else
    echo "!!! Create initial host defaults"
    sethost sysadm@$(hostname -f) $1 $(newpw 5)
    gethost > ~/.defaults
    chmod 600 ~/.defaults
fi

[[ ! -d $VPATH ]] && echo "!!! Create $VPATH" && mkdir $VPATH

if [[ $DTYPE == mysql ]]; then
    if [[ -f ~/.my.cnf ]]; then
        echo "!!! WARNING: ~/.my.cnf already exists, you may need to manually update ~/.defaults"
    else
        cat << EOS | tee ~/.my.cnf > /dev/null
[client]
host = $DHOST
port = $DPORT
user = root
password = $DPASS
EOS
        chmod 600 ~/.my.cnf
    fi
fi

grep -q '^#precedence ::ffff:0:0/96  100' /etc/gai.conf
if [[ $? -eq 0 ]]; then
    echo "!!! Warning: giving preference to IPv4 over IPv6 (Ubuntu default)"
    sed -i 's;#precedence ::ffff:0:0/96  100;precedence ::ffff:0:0/96  100;' /etc/gai.conf
fi

if [[ ! -f /etc/apt/sources.list.orig ]]; then
    mv /etc/apt/sources.list /etc/apt/sources.list.orig
    if [[ -f /etc/NetworkManager/NetworkManager.conf ]]; then
        echo "!!! Setup apt sources list for '$OSREL' DESKTOP"
        cat << EOS | tee /etc/apt/sources.list > /dev/null
# apt-key adv --recv-keys --keyserver keyserver.ubuntu.com KEY
# apt-get install --no-install-recommends packages

deb http://$OSMIR/ubuntu $OSREL main universe multiverse restricted
deb http://$OSMIR/ubuntu $OSREL-updates main universe multiverse restricted
deb http://$OSMIR/ubuntu $OSREL-backports main universe multiverse restricted
deb http://security.ubuntu.com/ubuntu $OSREL-security main universe multiverse restricted
#
# for adobe-flashplugin
deb http://archive.canonical.com/ubuntu $OSREL partner
#
# rolling release KDE packages (possibly unstable at times)
#deb http://ppa.launchpad.net/kubuntu-ci/stable/ubuntu $OSREL main
#
# latest Firefox and Thunderbird packages
#deb http://ppa.launchpad.net/mozillateam/firefox-next/ubuntu artful main
#deb http://ppa.launchpad.net/mozillateam/thunderbird-next/ubuntu artful main
EOS
    else
        echo "!!! Setup apt sources list for '$OSREL' SERVER"
        cat << EOS | tee /etc/apt/sources.list > /dev/null
# apt-key adv --recv-keys --keyserver keyserver.ubuntu.com KEY
# apt-get install --no-install-recommends packages

deb http://$OSMIR/ubuntu $OSREL main universe
deb http://$OSMIR/ubuntu $OSREL-updates main universe
deb http://$OSMIR/ubuntu $OSREL-backports main universe
deb http://security.ubuntu.com/ubuntu $OSREL-security main universe
EOS
    fi
    echo "!!! Updating package list for '$OSREL', patience please..."
    apt-get -yqq update > /dev/null
    DEBIAN_FRONTEND=noninteractive apt-get -yqq --no-install-recommends -u dist-upgrade
fi

if [[ ! -f /etc/ssh/sshd_config.orig ]]; then
    echo "!!! Create new /etc/ssh/sshd_config"
    mv /etc/ssh/sshd_config /etc/ssh/sshd_config.orig
    cat << EOS | tee /etc/ssh/sshd_config > /dev/null
Port 9
MaxAuthTries 3
MaxSessions 3
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
MaxStartups 1
AcceptEnv LANG LC_*
Subsystem sftp internal-sftp -u 0027
Match User u*
  ChrootDirectory %h
  X11Forwarding no
  AllowTcpForwarding no
EOS
    systemctl restart ssh
fi

if [[ ! -d ~/.ssh ]]; then
    echo "!!! Create host ~/.ssh dir"
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

if [[ ! -f ~/.ssh/id_rsa ]]; then
    echo "!!! Create host ~/.ssh/id_rsa key"
    ssh-keygen -t rsa -f ~/.ssh/id_rsa -N '' > /dev/null
    cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    chmod 600 ~/.ssh/*
fi

if [[ ! -f ~/.ssh/config ]]; then
    echo "!!! Create host ~/.ssh/config"
    cat << EOS | tee -a ~/.ssh/config > /dev/null
Host *
  TCPKeepAlive yes
  ServerAliveInterval 30
  IdentityFile ~/.ssh/id_rsa
EOS
    chmod 600 ~/.ssh/*
fi

if [[ -d /etc/NetworkManager/NetworkManager.conf ]]; then
    if [[ ! -f /etc/NetworkManager/dispatcher.d/99iptables ]]; then
        echo "!!! Create desktop iptables save/restore"
        cp ~/.sh/etc/_etc_NetworkManager_dispatcher.d_99iptables \
            /etc/NetworkManager/dispatcher.d/99iptables
        chmod +x /etc/NetworkManager/dispatcher.d/99iptables
    fi
else
    if [[ ! -f /etc/network/if-post-down.d/iptsave ]]; then
        echo "!!! Create server iptables save/restore (update for systemd-networkd)"
        cp ~/.sh/etc/_etc_network_if-post-down.d_iptsave \
            /etc/network/if-post-down.d/iptsave
        chmod +x /etc/network/if-post-down.d/iptsave

        cp ~/.sh/etc/_etc_network_if-pre-up.d_iptrestore \
            /etc/network/if-pre-up.d/iptrestore
        chmod +x /etc/network/if-pre-up.d/iptrestore
    fi
fi

[[ ! -f /etc/iptables.rules ]] && ssheriff clear && ssheriff

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
