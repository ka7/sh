#!/usr/bin/env bash
# .sh/bin/delvmail 20170418 - 20180420
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 || $1 =~ -h ]] && echo "Usage: delvmail user@domain" && exit 1

[[ $EUID -gt 0 ]] && echo "*** ERROR: must be root (use sudo -i)" && exit 2

VHOST=${1#*@} # userid @ $VHOST

source ~/.vhosts/$VHOST || exit 3

VUSER=${1%@*} # $VUSER @ domain
HPATH="$VPATH/$VHOST/home"
MPATH="$HPATH/$VUSER"

if [[ -d $MPATH ]]; then
    echo "*** Remove $MPATH"
    rm -rf $MPATH
else
    echo "*** ERROR: $MPATH does not exist"
    exit 4
fi

MID=$(cat << EOS | $SQCMD
 SELECT id FROM vmails
  WHERE user = '$1'
EOS
)

if [[ -z $MID ]]; then
    echo "*** Warning: '$1' does not exist in $ADMIN.vmails"
else
    echo "*** Remove '$1' from $ADMIN.vmails ($DTYPE)"
    cat << EOS | $SQCMD
 DELETE FROM vmails
  WHERE id = $MID
EOS
fi

AID=$(cat << EOS | $SQCMD
 SELECT id FROM valias
  WHERE target = '$1'
EOS
)

if [[ -z $AID ]]; then
    echo "*** Warning: '$1' does not exist in $ADMIN.valias"
else
    echo "*** Remove '$1' from $ADMIN.valias ($DTYPE)"
    cat << EOS | $SQCMD
 DELETE FROM valias
  WHERE target = '$1'
EOS
fi

LID=$(cat << EOS | $SQCMD
 SELECT id FROM mail_log
  WHERE mid = '$MID'
EOS
)

if [[ -z $LID ]]; then
    echo "*** Warning: '$1' does not exist in $ADMIN.mail_log"
else
    echo "*** Remove '$1' from $ADMIN.mail_log ($DTYPE)"
    cat << EOS | $SQCMD
 DELETE FROM mail_log
  WHERE mid = '$MID'
EOS
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
