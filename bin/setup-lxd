#!/usr/bin/env bash
# .sh/bin/setup-lxd 20170519 - 20180303
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 =~ '-h' ]] && \
    echo "Usage: setup-lxd [pool size (25) GB] [passwd] [IP]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

_STOR=btrfs

PSIZE=${1:-'25'}
APASS=${2:-$(newpw 1)}
IP4_0=${3:-$(hostname -i|cut -d ' ' -f -1)}

if [[ -d /var/lib/lxd ]]; then
    echo "--- Warning: lxd already installed"
else
    echo "--- Install packages for lxd lxd-client bridge-utils btrfs-progs btrfs-tools zfsutils-linux"

    [[ $(($(stat -c %X /var/cache/apt/pkgcache.bin)+3600)) < $(date +%s) ]] &&\
        apt-get -qq update > /dev/null

    DEBIAN_FRONTEND=noninteractive \
        apt-get -yqq install --no-install-recommends \
        lxd lxd-client zfsutils-linux bridge-utils > /dev/null
fi

lxc storage list | grep lxd-pool > /dev/null

if [[ $? -eq 0 ]]; then
    echo "--- Warning: lxd-pool already installed"
else
    echo "--- Install lxd with $PSIZE GB lxd-pool at $IP4_0 with pw $APASS"
    # switch group to lxd
    sg lxd -c "lxd init --auto \
      --network-address $IP4_0 \
      --network-port 8443 \
      --storage-backend $_STOR \
      --storage-create-loop $PSIZE \
      --storage-pool lxd-pool \
      --trust-password $APASS"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
