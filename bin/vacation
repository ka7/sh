#!/usr/bin/env bash
# .sh/bin/vacation 20201224 - 20211223
# Copyright (C) 1995-2022 Mark Constable <markc@renta.net> (AGPL-3.0)

# Vacation file format is plain text with the Suject on the first line
# followed by the message content with no empty lines.

[[ -z $2 || $1 =~ -h ]] && echo "Usage: vacation email vacation_file" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

. ~/.shrc || exit 3

EMAIL=${1}

if [[ ! -f $2 ]]; then
    echo "ERROR: missing vacation text file"
    exit 3
fi

_SUBJ=$(head -n 1 $2)
[[ -z $_SUBJ ]] && echo "ERROR: Missing Subject" && exit

_MESG=$(tail -n +2 $2)
[[ -z $_MESG ]] && echo "ERROR: Missing Message" && exit

_PATH="$VPATH/${EMAIL#*@}/home/${EMAIL%@*}"

[[ ! -d $_PATH/sieve ]] && echo "ERROR: Missing sieve directory ($_PATH/sieve)" && exit

SIEVE="$_PATH/sieve/vacation.sieve"

echo "Save to $SIEVE"

cat << EOS > $SIEVE
require ["vacation"];
# rule:[Out of office]
if true
{
        vacation :days 1 :addresses "$EMAIL" :subject "$_SUBJ" :from "$EMAIL" text:
$_MESG
.
;
        keep;
}
EOS

sievec $SIEVE
chown $(stat -c '%u:%g' $_PATH) -R $_PATH/sieve
