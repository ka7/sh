#!/usr/bin/env bash
# .sh/bin/setup-ct 20221229 - 20221229
# Copyright (C) 1995-2022 Mark Constable <markc@renta.net> (AGPL-3.0)

# Latest Ubuntu LTS (manually update this to YOUR storage:vztmpl/*)
_TMPL="ceph-fs:vztmpl/ubuntu-22.04-standard_22.04-1_amd64.tar.zst"

[[ -z $1 || $1 =~ -h ]] && echo "Usage: setup-ct ctname [storage]" && exit 1
[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2
[[ ! -d /etc/pve ]] && echo "ERROR: $0 only works on a Proxmox host" && exit 3

[[ $DEBUG ]] && set -x

_NAME=$1
_STOR=${2:'local-zfs'}
_CTID=`pvesh get /cluster/nextid`

pct create $_CTID $_TMPL \
 -ostype ubuntu \
 -hostname $_NAME \
 -cores 2 \
 -memory 1024 \
 -swap 512 \
 -rootfs volume=$_STOR:4G \
 -net0 name=eth0,bridge=vmbr0,ip=dhcp

pct start $_CTID

pct exec $_CTID -- mkdir -p /root/.ssh && chmod 700 /root/.ssh
pct push $_CTID ~/.ssh/authorized_keys /root/.ssh/authorized_keys
pct exec $_CTID -- chmod 600 /root/.ssh/*
pct exec $_CTID -- bash -c "apt update && apt full-upgrade -y && apt install -q -y git nano wget"
pct exec $_CTID -- bash <(wget -qLO - https://raw.githubusercontent.com/netserva/sh/master/bin/setup-sh)

[[ $DEBUG ]] && set +x
