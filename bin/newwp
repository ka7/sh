#!/usr/bin/env bash
# .sh/bin/newwp 20160231 - 20170528
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

#wp core install --quiet --url=$VHOST --title='$TITLE' --admin_user=admin --admin_password=$APASS --admin_email=$AMAIL

[[ -z $1 ]] && echo "Usage: newwp user@domain|domain [wp_passwd] [db_passwd] [path]" && exit 1
[[ ! -d $VPATH ]] && echo "!!! ERROR: $VPATH does NOT exist, run 'setup-host' first" && exit 2

# only needed if $1 is plain hostname (not FQDN)
#[[ $1 =~ \. ]] && VHOST=$1 || VHOST=$(host -t a $1 | cut -d' ' -f1)

APASS=${2:-$APASS}
DPASS=${3:-$APASS}
FPATH=${4:-''}
sethost $1 $APASS $DPASS
[[ ! -d $WPATH ]] && echo "!!! ERROR: $WPATH does NOT exist, run 'addvhost' first" && exit 2
gethost > $UPATH/etc/defaults
TITLE=$(echo $VHOST|tr 'a-z' 'A-Z')

[[ -d $C_SSL/$VHOST ]] && SCHEME="https://" || SCHEME="http://"

if [[ $FPATH ]]; then
    WPURL=$SCHEME$VHOST/$FPATH
    FPATH=$WPATH/$FPATH
else
    WPURL=$SCHEME$VHOST
    FPATH=$WPATH
fi

[[ -d $UPATH/var/www_old/public ]] && mv $UPATH/var/www_old/public $WPATH
[[ -d $UPATH/var/www_old/private ]] && mv $UPATH/var/www_old/private $WPATH

if [[ ! -x /usr/local/bin/wp ]]; then
    echo "!!! Install wp-cli as /usr/local/bin/wp"
    curl -s -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    mv wp-cli.phar /usr/local/bin/wp
fi

if [[ $(mysql -BNe "SHOW DATABASES LIKE '$DNAME'") ]]; then
    echo "!!! '$DNAME' database already exists"
else
    echo "!!! Create $DNAME database"
    mysql -e "CREATE DATABASE IF NOT EXISTS $DNAME"
    mysql -e "GRANT ALL PRIVILEGES ON $DNAME.* TO '$DUSER'@'localhost' IDENTIFIED BY '$DPASS'";
    mysql -e "FLUSH PRIVILEGES"
fi

if [ ! -f "$FPATH/wp-config-sample.php" ]; then
    echo "!!! Download Wordpress"
    cd $UPATH/var
    if [[ ! -f latest.tar.gz ]]; then
        wget -q --no-check-certificate https://wordpress.org/latest.tar.gz
    fi
    tar xf latest.tar.gz
    rm latest.tar.gz
    [[ -d $FPATH ]] && mv $FPATH ${FPATH}_old
    mv wordpress $FPATH
    chown $U_UID:www-data -R $FPATH
fi

if [ ! -f "$FPATH/wp-config.php" ]; then
    echo "!!! Setting up Wordpress"
    su - $VUSER -c "
cd $FPATH
wp core config --quiet --dbname='$DNAME' --dbuser='$DUSER' --dbpass='$DPASS'
wp core install --quiet --url='$WPURL' --title='$TITLE' --admin_user=admin --admin_password='$APASS' --admin_email='$AMAIL'
wp plugin install --quiet contact-form-7 --activate
wp plugin install --quiet smart-wp-login --activate
wp plugin install --quiet user-switching --activate"

    cd $FPATH/wp-content/themes
    git clone https://github.com/markc/twentyseventeen-child
    chperms $VHOST
    su - $VUSER -c "wp theme activate twentyseventeen-child"
    echo "
Web
========

Wordpress: $WPURL/wp-admin/
Username: $AMAIL
Password: $APASS
"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
