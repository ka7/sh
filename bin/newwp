#!/usr/bin/env bash
# .sh/bin/newwp 20160231 - 20180203
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 ]] && echo "Usage: newwp user@domain|domain [wp_passwd] [db_passwd] [path]" && exit 1

source ~/.defaults || exit 2

[[ ! -d $VPATH ]] && echo "!!! ERROR: $VPATH does NOT exist, run 'setup-host' first" && exit 3

WPASS=${2:-$WPASS}
DPASS=${3:-$DPASS}
FPATH=${4:-''}
WUSER=$(pwgen 6 -s -B -C -N 1 -A -0) # unique 6 char Wordpress login ID

sethost $1 $WPASS $DPASS
TITLE=$(echo $VHOST|tr 'a-z' 'A-Z')

[[ ! -d $WPATH ]] && echo "!!! ERROR: $WPATH does NOT exist, run 'addvhost' first" && exit 2

[[ -d $C_SSL/$VHOST ]] && SCHEME="https://" || SCHEME="http://"

if [[ $FPATH ]]; then
    WPURL=$SCHEME$VHOST/$FPATH
    FPATH=$WPATH/$FPATH
else
    WPURL=$SCHEME$VHOST
    FPATH=$WPATH
fi

[[ -d $UPATH/var/www_old/public ]] && mv $UPATH/var/www_old/public $WPATH
[[ -d $UPATH/var/www_old/private ]] && mv $UPATH/var/www_old/private $WPATH

if [[ ! -x /usr/local/bin/wp ]]; then
    echo "!!! Install wp-cli as /usr/local/bin/wp"
    curl -s -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    mv wp-cli.phar /usr/local/bin/wp
fi

if [[ $(mysql -BNe "SHOW DATABASES LIKE '$DNAME'") ]]; then
    echo "!!! '$DNAME' database already exists"
else
    echo "!!! Create $DNAME database"
    mysql -e "CREATE DATABASE IF NOT EXISTS $DNAME"
    mysql -e "GRANT ALL PRIVILEGES ON $DNAME.* TO '$DUSER'@'localhost' IDENTIFIED BY '$DPASS'";
    mysql -e "FLUSH PRIVILEGES"
fi

if [ ! -f "$FPATH/wp-config-sample.php" ]; then
    echo "!!! Download Wordpress"
    cd $UPATH/var
    if [[ ! -f latest.tar.gz ]]; then
        wget --no-check-certificate https://wordpress.org/latest.tar.gz
    fi
    tar xf latest.tar.gz
    rm latest.tar.gz
    [[ -d $FPATH ]] && mv $FPATH ${FPATH}_old
    mv wordpress $FPATH
    chown $U_UID:www-data -R $FPATH
fi

if [ ! -f "$FPATH/wp-config.php" ]; then
    echo "!!! Setting up Wordpress"
    rm -rf $FPATH/wp-content/{themes/*,plugins/*}
    su - $VUSER -c "
cd $FPATH
wp core config --quiet --dbname='$DNAME' --dbuser='$DUSER' --dbpass='$DPASS'
wp core install --quiet --url='$WPURL' --title='$TITLE' --admin_user='$WUSER' --admin_password='$WPASS' --admin_email='$AMAIL'
wp theme install --quiet astra --activate
wp plugin install --quiet astra-sites --activate
wp plugin install --quiet elementor --activate
wp plugin install --quiet header-footer-elementor --activate
wp plugin install --quiet contact-form-7 --activate
wp plugin install --quiet force-email-login --activate
wp plugin install --quiet user-switching --activate
wp plugin install --quiet woocommerce
wp plugin install --quiet autoptimize
wp plugin install --quiet wp-super-cache
wp plugin install --quiet google-analytics-dashboard-for-wp
wp plugin install --quiet mainwp-child
wp plugin uninstall --quiet hello-dolly
"

#    cd $FPATH/wp-content/themes
#    git clone https://github.com/markc/astra-child
    chperms $VHOST
#    su - $VUSER -c "wp theme activate astra-child"
    echo "
Web
========

Wordpress: $WPURL/wp-admin/
Username: $AMAIL
Password: $WPASS
"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
