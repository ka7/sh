#!/usr/bin/env bash
# .sh/bin/sshkey 20181119 - 20181119
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)
set -x
[[ -z $1 || $1 =~ '-h' ]] && echo "Usage: sshkey add|create|del|list [sshkey] [user]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "!!! ERROR: must be root (use sudo -i)" && exit 2

SKCMD=$1
S_KEY=${2:-'id_rsa'}
LUSER=${3:-$USER}
LHOME=$(eval echo ~$LUSER)
VHOST=$(hostname -f)

if [[ ! -d $LHOME/.ssh ]]; then
    echo ">>> Create local $LHOME/.ssh dir"
    mkdir $LHOME/.ssh
    chown $LUSER:$LUSER $LHOME/.ssh
    chmod 700 $LHOME/.ssh
fi

if [[ $1 == add ]]; then
    echo "Add key (paste public key into editor, ctrl-x to save and quit)"
    sleep 2
    nano -t -x -c $LHOME/.ssh/authorized_keys
elif [[ $1 == create ]]; then
    echo "Create key"
    su - $LUSER -c "
cd .ssh
ssh-keygen -f $LHOME/.ssh/$S_KEY -N '' -C $S_KEY@$VHOST >/dev/null 2>&1
chmod 600 *"
    cat $LHOME/.ssh/$S_KEY.pub
elif [[ $1 == del ]]; then
    grep $S_KEY $LHOME/.ssh/authorized_keys
    if [[ $? -eq 0 ]]; then
        echo "Delete public key"
        sed -i $LHOME/.ssh/authorized_keys '/'"$S_KEY"'/d'
    else
        echo "$S_KEY does not exist in $LHOME/.ssh/authorized_keys"
    fi
    PRIVK=${S_KEY%@*}
    if [[ -f $LHOME/.ssh/$PRIVK ]]; then
        echo "Delete private key $LHOME/.ssh/$PRIVK"
        rm $LHOME/.ssh/$PRIVK
    else
        echo "$LHOME/.ssh/$S_KEY does not exist"
    fi
elif [[ $1 == list ]]; then
    if [[ -f $LHOME/.ssh/authorized_keys ]]; then
        cat $LHOME/.ssh/authorized_keys | awk '{print $3}'
    fi
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
