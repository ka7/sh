#!/usr/bin/env bash
# .sh/bin/shmail 20150529 - 20210523
# Copyright (C) 1995-2021 Mark Constable <markc@renta.net> (AGPL-3.0)

#VHOST=${_ARG1#*@} # userid @ $VHOST
#VUSER=${_ARG1%@*} # $VUSER @ domain

[[ -z $1 || $1 =~ '-h' ]] && echo "Usage: shmail email@|domain" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

_ARG1=${1,,} # lowercase user@domain
VPATH="/home/u"
VUSER='*'
VHOST='*'

if [[ $1 =~ "@" ]]; then
    VUSER="*${1%@*}*";
    VHOST="${1#*@}*";
else
    VHOST="*$1*"
fi

HPATH="$VPATH/$VHOST/home"
MPATH="$HPATH/$VUSER"

/bin/ls -d ${MPATH}/Maildir > /dev/null 2>&1
if [[ $? -gt 0 ]]; then
    echo "ERROR: ${MPATH}/Maildir does not exist"
    exit 3
fi

_MBOX=$(/bin/ls -d ${MPATH}/Maildir)
_MNUM=$(echo $_MBOX|wc -w)

if [[ $_MNUM -eq 1 ]]; then
    cd ${MPATH}/Maildir
    find -maxdepth 2 -type d -name "new" -o -name "cur"|sort -f|xargs -0| (
        while read dir; do
            [[ -z $dir ]] && continue
            N1=0; N2=0; N1STR=""; N2STR=""
            cd "$dir"
            N1=$(du -s|cut -f1)
            N2=$(find -type f|wc -l)
            cd - > /dev/null
            NTOTAL=$(($NTOTAL+$N2))
            if [[ $N1 -lt 5 ]]; then
                N1STR=" "
            elif [[ $N1 -lt 1000 ]]; then
                N1STR="${N1}K"
            elif [[ $N1 -lt 1000000 ]]; then
                N1STR="${N1}M"
            else
                N1STR=$(printf "%'6.3fG" $(echo $N1/1000000|bc -l))
            fi
            [[ $N2 -eq 0 ]] && N2STR=" " || N2STR=$N2
            printf "%-42s %8s %10s\n" "$(echo $dir|cut -c 3-)" "$N2STR" "$N1STR"
        done
        STOTAL=$(du -s ${MPATH}|cut -f1)
        echo "-----------------------------------------------------------"
        printf "%-42s %8s %'6.3fG\n" Total $NTOTAL $(echo $STOTAL/1000000|bc -l)
        echo "-----------------------------------------------------------"
    )
    # OSTYP not available here
    if [[ -f /etc/alpine-release ]]; then
        find . -type l
    else
        find -L . -xtype l
    fi
    [ -d ${MPATH}/.spamprobe ] && du -h ${MPATH}/.spamprobe | awk '{printf "%-52s %6s\n", $2, $1}'

else
    du -s ${_MBOX}|sort -n|while read -r _size _path; do \
        _fnum=$(find $_path -type f|wc -l); \
        [[ $_fnum -eq 0 ]] && continue; \
        _mail=$(echo $_path|sed 's:/home/u/\(.*\)/home/\(.*\)/Maildir:\2@\1:'); \
        if [[ $_size -lt 5 ]]; then \
            _sstr=" "; \
        elif [[ $_size -lt 1000 ]]; then \
            _sstr="${_size}K"; \
        elif [[ $_size -lt 1000000 ]]; then \
            _sstr=$(printf "%'6.3fM" $(echo $_size/1000|bc -l)); \
        else \
            _sstr=$(printf "%'6.3fG" $(echo $_size/1000000|bc -l)); \
        fi \
        printf "%-42s %8d %s\n" $_mail $_fnum $_sstr; \
    done
fi
